<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>V√≤ng quay may m·∫Øn</title>
<style>
/* ----- BODY & BACKGROUND ----- */
body {
margin: 0;
font-family: 'Poppins', sans-serif;
background: linear-gradient(135deg, #8b5cf6, #2563eb, #ec4899);
background-size: 400% 400%;
animation: bgMove 12s ease infinite;
min-height: 100vh;
display: flex;
flex-direction: column;
align-items: center;
padding-top: 30px;
color: white;
overflow-x: hidden;
}
@keyframes bgMove {
0% { background-position: 0% 50%; }
50% { background-position: 100% 50%; }
100% { background-position: 0% 50%; }
}
/* ----- RESPONSIVE ADMIN ----- */
@media (max-width: 600px) {
#adminBtns {
flex-direction: column;
gap: 15px;
margin-top: 20px;
}
#adminBtns button {
width: 80%;
padding: 12px 0;font-size: 16px;
}
#selectAllContainer {
text-align: center;
margin-bottom: 15px;
font-size: 14px;
}
#selectAllContainer input[type="checkbox"] {
transform: scale(1.2);
margin-right: 6px;
}
}

/* ----- LOGIN OVERLAY ----- */
#loginOverlay {
position: fixed;
top: 0; left: 0;
width: 100%; height: 100%;
background: rgba(0,0,0,0.6); display: flex;
justify-content: center;
align-items: center;
z-index: 1000;
backdrop-filter: blur(6px);
animation: fadeIn 0.5s ease forwards;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.loginBox {
background: rgba(255,255,255,0.12);
padding: 40px 50px;
border-radius: 25px;
box-shadow: 0 10px 30px rgba(0,0,0,0.6);
text-align: center;
color: white;
min-width: 320px;
max-width: 500px;
width: 90%;
animation: slideUp 0.5s ease forwards;
}
@keyframes slideUp { from { transform: translateY(50px); opacity:0; } to { transform: translateY(0); opacity:1; } }

.loginBox h2 {
margin-bottom: 25px;
font-size: 28px;
text-shadow: 0 4px 15px rgba(0,0,0,0.4);
}

.loginBox input,
.loginBox button {
width: 100%;
padding: 14px 18px;
border-radius: 12px;
border: none;
font-size: 18px;
outline: none;
box-shadow: inset 0 4px 10px rgba(0,0,0,0.2);
background: rgba(255,255,255,0.2);
color: white;
margin-bottom: 20px;
box-sizing: border-box;
}
.loginBox button {
background: linear-gradient(135deg, #8b5cf6, #6366f1);
font-weight: bold;
cursor: pointer;
transition: 0.3s;
}
.loginBox button:hover {
transform: scale(1.05);
box-shadow: 0 8px 20px rgba(0,0,0,0.45);
}

/* ----- GRID & CELLS ----- */
h1 { font-size: 42px; font-weight: 700; margin-bottom: 10px; text-align: center; text-shadow: 0 4px 20px rgba(0,0,0,0.4);}
.grid { display: grid; grid-template-columns: repeat(8, 150px); grid-auto-rows: 75px; gap: 18px; margin-top: 40px;}
.cell {
display: flex; justify-content: center; align-items: center;
background: rgba(255,255,255,0.25); border: 2px solid rgba(255,255,255,0.4);
border-radius: 15px; font-weight: 600; font-size: 18px; color: white;
cursor: grab; transition: 0.25s; box-shadow: 0 6px 18px rgba(0,0,0,0.25);
user-select: none;
}
.cell.dragging { opacity: 0.5; transform: scale(1.05); cursor: grabbing; }
.cell.empty { background: rgba(255,255,255,0.05); border: 2px dashed rgba(255,255,255,0.3); cursor: pointer; }
.selected { background: linear-gradient(135deg, #60a5fa, #2563eb); border-color: #ffffff; transform: scale(1.07); box-shadow: 0 0 20px #60a5fa; }
.btn-area { margin-top: 40px; display: flex; gap: 30px; flex-wrap: wrap; justify-content: center;}
button { padding: 14px 30px; border: none; border-radius: 15px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.25s; color: white; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 6px 15px rgba(0,0,0,0.25);}
#startBtn { background: linear-gradient(135deg, #8b5cf6, #6366f1);}
#stopBtn { background: linear-gradient(135deg, #ec4899, #db2777);}
#confirmBtn {justify-content: center;align-items: center; display: none; padding: 20px 40px; font-size: 28px; border: none; border-radius: 20px; background: linear-gradient(135deg, #facc15, #f59e0b); color: black; font-weight: bold; cursor: pointer; box-shadow: 0 6px 15px rgba(0,0,0,0.25); width: 80%; max-width: 400px; margin-top: 450px;}
#resultBox { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); background: white; padding: 40px 60px; border-radius: 25px; box-shadow: 0 0 35px rgba(0,0,0,0.45); font-size: 40px; font-weight: 700; color: #2563eb; opacity: 0; transition: 0.35s ease; z-index: 999;}
#resultBox.show { transform: translate(-50%, -50%) scale(1); opacity: 1;}
canvas#fireworks { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 998;}
#cancelBtn { padding:20px 40px; font-size:24px; border-radius:15px; background: linear-gradient(135deg, #f87171, #ef4444); color:white; font-weight:bold; cursor:pointer; margin-top:500px; display: none;}
@media (max-width: 600px) {

 /* N√∫t tham gia & khung k·∫øt qu·∫£ gi·ªØ c√πng k√≠ch th∆∞·ªõc */
 #confirmBtn, 
#resultBox {
 width: 90% !important;
 max-width: 90% !important;
}

#resultBox {
padding: 6px 20px !important; /* tho√°ng h∆°n nh∆∞ng kh√¥ng tr√†n */
font-size: 20px !important;  /* v·ª´a cho m·ªçi t√™n k·ªÉ c·∫£ d√†i */
text-align: center !important;

 display: flex !important;
 justify-content: center;
 align-items: center;
 gap: 8px;

 white-space: normal !important; /* Cho text xu·ªëng d√≤ng khi qu√° d√†i */
 word-break: break-word !important; /* NgƒÉn tr√†n ra ngo√†i */
 }

 /* Icon ph√°o hoa co l·∫°i ƒë·ªÉ ph√π h·ª£p mobile */
 #resultBox img {
 width: 20px !important;
height: 20px !important;
}
}

@media (max-width: 400px) {
 #confirmBtn, #resultBox {
 max-width: 95%;
 width: 95%;
 }
 #resultBox {
padding: 2px 20px; /* Gi·∫£m padding tr√™n d∆∞·ªõi xu·ªëng 2px */
 font-size: 18px; /* Gi·∫£m font size cho m√†n h√¨nh r·∫•t nh·ªè */
 }
}
/* ----- RESPONSIVE ----- */
@media (max-width: 600px) {
.grid { grid-template-columns: repeat(4, 45vw); grid-auto-rows: 20vw; gap: 10px; margin-top: 20px;}
h1 { font-size: 32px; }
}
/* ----- DANH S√ÅCH THAM GIA ADMIN ----- */
#participantListContainer {
 background-color: rgba(0, 0, 0, 0.2);
 padding: 20px;
 margin-top: 40px;
 border-radius: 15px;
color: white;
 width: 90%;
 max-width: 600px;
 box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

#participantListContainer h2 {
 margin-top: 0;
 margin-bottom: 15px;
 font-size: 24px;
 border-bottom: 2px solid rgba(255, 255, 255, 0.4);
 padding-bottom: 10px;
}

#listControls {
 margin-bottom: 15px;
display: flex;
 gap: 10px;
 flex-wrap: wrap;
}

#listControls button {
 padding: 8px 15px;
 font-size: 14px;
border-radius: 8px;
 font-weight: 500;
}

#participantList {
 list-style: none;
 padding: 0;
 max-height: 250px;
 overflow-y: auto; /* Th√™m thanh cu·ªôn khi danh s√°ch d√†i */
 display: flex;
 flex-wrap: wrap; /* Cho ph√©p t√™n ng∆∞·ªùi tham gia n·∫±m tr√™n c√πng m·ªôt h√†ng v√† xu·ªëng d√≤ng n·∫øu c·∫ßn */
 gap: 8px;
}

#participantList li {
 background-color: rgba(255, 255, 255, 0.1);
 padding: 5px 10px; border-radius: 5px;
 font-size: 16px;
}
</style>
</head>
<body>

<script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

<div id="loginOverlay">
  <div class="loginBox">
    <h2>Nh·∫≠p t√™n c·ªßa b·∫°n</h2>
    <input type="text" id="usernameInput" placeholder="Nh·∫≠p t√™n..." />
    <p id="loginError" style="color:#ffb4b4; font-size:14px; margin-top:-10px; height:18px;"></p>
    <button id="loginBtn">B·∫Øt ƒë·∫ßu</button>
  </div>
</div>

<canvas id="fireworks"></canvas>
<h1>V√≤ng quay may m·∫Øn</h1>

<div class="grid" id="grid"></div>

<div class="btn-area" id="adminBtns">
  <button id="startBtn">B·∫Øt ƒë·∫ßu</button>
  <button id="stopBtn">D·ª´ng</button>
</div>
<div id="adminControls" style="display:none; align-items:center; gap:10px; margin-top:20px;">
  <input type="checkbox" id="selectAllCheckbox" />
  <label for="selectAllCheckbox" style="color:white; font-weight:bold;">Ch·ªçn t·∫•t c·∫£</label>
</div>

<button id="confirmBtn">Tham gia</button>
<button id="cancelBtn">H·ªßy tham gia</button>

<div id="participantListContainer" style="display:none;"><!-- ===== ADMIN STATS ===== -->
<div id="statsBox" style="
margin-top:25px;
background:rgba(0,0,0,0.25);
padding:20px;
border-radius:15px;
box-shadow:0 4px 15px rgba(0,0,0,0.3);
">
  <h2 style="margin-top:0;">üìä Th·ªëng k√™ tr√∫ng th∆∞·ªüng</h2>

  <button id="loadStatsBtn"
    style="
    margin-bottom:15px;
    padding:10px 18px;
    border-radius:10px;
    border:none;
    font-weight:bold;
    background:linear-gradient(135deg,#22c55e,#16a34a);
    color:white;
    cursor:pointer;">
    Xem th·ªëng k√™
  </button>

  <table style="width:100%;border-collapse:collapse;text-align:center;">
    <thead>
      <tr style="background:rgba(255,255,255,0.15);">
        <th>T√™n</th>
        <th>Tham gia</th>
        <th>Tr√∫ng</th>
        <th>%</th>
      </tr>
    </thead>
    <tbody id="statsTableBody"></tbody>
  </table>
</div>

    <h2>Danh s√°ch Tham gia (<span id="participantCount">0</span>)</h2>
    <div id="listControls">
        <button id="copyListBtn">üìã Copy Danh s√°ch</button>
        <button id="resetListBtn" style="background: linear-gradient(135deg, #ef4444, #b91c1c);">X√≥a Danh s√°ch</button>
    </div>
    <ul id="participantList">
        </ul>
</div>
<div id="resultBox"></div>
<audio id="tickSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_7f4fb39984.mp3"></audio>

<script>
// ----- DANH S√ÅCH & C√ÄI ƒê·∫∂T -----
const names = [
"Trung Ki√™n","Gia Khang","Nam Nguy√™n","B·∫£o Ng·ªçc","Ho√†ng Gia","Kh√°nh Dung","ƒêan L√™","Minh Huy",
"Qu·ª≥nh Nh∆∞","Quang Nam","Ph√∫ Th·ªãnh","T·∫•n T√†i",
"VƒÉn H√†o","Ho√†ng Anh","Ho√†ng Long","Gia Huy",
"Gia Ph√∫c","Di·ªáu Minh","C√¥ng Tr√≠","Minh Qu√¢n","V√µ Gia H√¢n","Thu An","Ph∆∞∆°ng Linh",
"Th·∫£o Hi·ªÅn","Ho√†ng Phong","H√πng Minh",
"Th√∫y Vy","Ho√†ng Ph∆∞∆°ng","Gia H√¢n","ƒê·ª©c An","Anh Ki·ªát","Gia H∆∞ng","Ho√†ng Nhi","Di·ªÖm My","Nam Trung","Kh√°nh Qu·ª≥nh","Li√™n Giang",
"Tr√¢m Anh","C√¥ng Khoa","Nh·∫≠t Huy","Th·∫£o Nguy√™n","H·∫°nh Nghi","B·∫£o Tr√¢n",
"Minh Th∆∞","Anh ƒê·ª©c","H·ªìng Chuy√™n"
];

const grid = document.getElementById("grid");
const adminBtns = document.getElementById("adminBtns");
const confirmBtn = document.getElementById("confirmBtn");
const cancelBtn = document.getElementById("cancelBtn");
const resultBox = document.getElementById("resultBox");
const tick = document.getElementById("tickSound");
const adminControls = document.getElementById("adminControls");

// KHAI B√ÅO BI·∫æN M·ªöI T·∫†I ƒê√ÇY (V·ªã tr√≠ 1)
const participantListContainer = document.getElementById('participantListContainer');
const participantCount = document.getElementById('participantCount');
const participantList = document.getElementById('participantList');
const copyListBtn = document.getElementById('copyListBtn');
const resetListBtn = document.getElementById('resetListBtn');
// K·∫æT TH√öC KHAI B√ÅO BI·∫æN M·ªöI

let selected = [];
let interval;
let currentIndex = 0;
let role = '';
let username = '';
let hasJoined = false;

const adminName = "backy";
const SERVER_PORT = 3000;
// THAY ƒê·ªîI 'localhost' th√†nh IP c·ªßa m√°y Server Node.js n·∫øu b·∫°n ch·∫°y tr√™n m√°y kh√°c!
const socket = io(`https://random-picker-4eht.onrender.com`); 


// ----- INIT V√Ä LOGIN -----
window.addEventListener('DOMContentLoaded', () => {
  // ƒê·∫£m b·∫£o m√†n h√¨nh ƒëƒÉng nh·∫≠p hi·ªán ra ƒë·∫ßu ti√™n
  document.getElementById('loginOverlay').style.display = 'flex';
  document.getElementById('usernameInput').value = '';
  adminBtns.style.display = 'none';
  confirmBtn.style.display = 'none';
  cancelBtn.style.display = 'none';
  adminControls.style.display = 'none';
});

document.getElementById('loginBtn').addEventListener('click', () => {
    const inputName = document.getElementById('usernameInput').value.trim();
    const errorMsg = document.getElementById('loginError');
    errorMsg.innerText = "";

    if (!inputName) {
        errorMsg.innerText = "‚ö† Vui l√≤ng nh·∫≠p t√™n!";
        return;
    }

    let nextRole = '';
    const userIndex = names.indexOf(inputName);

    // X√°c ƒë·ªãnh vai tr√≤
    if (inputName === adminName) {
        nextRole = 'admin';
    } else if (userIndex !== -1) { 
        nextRole = 'user';
    } else {
        errorMsg.innerText = "‚ö† T√™n kh√¥ng t·ªìn t·∫°i trong danh s√°ch!";
        return;
    }

    // L∆ØU TR·∫†NG TH√ÅI T·∫†M TH·ªúI V√Ä G·ª¨I Y√äU C·∫¶U L√äN SERVER
    username = inputName;
    role = nextRole;
   
    // G·ª≠i y√™u c·∫ßu ƒëƒÉng nh·∫≠p l√™n Server
    socket.emit('client_login', { username: inputName, role: nextRole, index: userIndex });
});

// --- L·∫ÆNG NGHE PH·∫¢N H·ªíI ƒêƒÇNG NH·∫¨P T·ª™ SERVER ---
socket.on('login_status', (data) => {
    const errorMsg = document.getElementById('loginError');

    if (data.success) {
        // ƒêƒÉng nh·∫≠p th√†nh c√¥ng
        errorMsg.innerText = "";
        document.getElementById('loginOverlay').style.display = 'none';

        if (role === 'admin') {
            adminBtns.style.display = 'flex';
            confirmBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            adminControls.style.display = 'flex';
            renderGrid();
            participantListContainer.style.display = 'block'; 
            document.getElementById('statsBox').style.display = 'block'; // <<< ƒê√É TH√äM D√íNG N√ÄY ƒê·ªÇ HI·ªÜN TH·ªêNG K√ä

        } else {
            // N·∫øu l√† user
            adminBtns.style.display = 'none';
            confirmBtn.style.display = 'flex';
            participantListContainer.style.display = 'none'; // ·∫®n v·ªõi User
        }
    } else {
        // ƒêƒÉng nh·∫≠p th·∫•t b·∫°i (do tr√πng l·∫∑p)
        errorMsg.innerText = data.message;
        // Reset tr·∫°ng th√°i t·∫°m th·ªùi
        role = '';
        username = '';
    }
});


// ----- GRID & RENDER -----
function createCell(name, idx, isEmpty=false){
  const cell = document.createElement("div");
  cell.className = "cell";
  if(isEmpty) cell.classList.add('empty');
  cell.innerText = name;
  cell.dataset.index = idx;
  cell.setAttribute('draggable', true);

  // Logic Drag & Drop (Ch·ªâ cho Admin)
  if(role === 'admin') {
    cell.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', idx);
      cell.classList.add('dragging');
    });

    cell.addEventListener('dragend', () => cell.classList.remove('dragging'));
    cell.addEventListener('dragover', e => e.preventDefault());
    cell.addEventListener('drop', e => {
      e.preventDefault();
      const fromIndex = e.dataTransfer.getData('text');
      const toIndex = idx;
      if (fromIndex === toIndex) return;

      const fromCell = document.querySelector(`[data-index='${fromIndex}']`);
      const toCell = document.querySelector(`[data-index='${toIndex}']`);
      const temp = fromCell.innerText;
      fromCell.innerText = toCell.innerText;
      toCell.innerText = temp;
      [names[fromIndex], names[toIndex]] = [names[toIndex], names[fromIndex]];
      // Sau khi swap, c·∫ßn ƒë·ªìng b·ªô l·∫°i tr·∫°ng th√°i selected cho ƒë√∫ng ng∆∞·ªùi
      selected.forEach((s, i) => {
        if (s == fromIndex) selected[i] = toIndex;
        else if (s == toIndex) selected[i] = fromIndex;
      });
    });
  }

  if(!isEmpty && role==='admin'){
  cell.addEventListener('click', ()=>{
    cell.classList.toggle('selected');

    const idx = parseInt(cell.dataset.index);
    if (idx < 0) return; // B·ªè qua n·∫øu l√† √¥ tr·ªëng (index √¢m)
    const username = names[idx];

    if (cell.classList.contains('selected')) {
      // T·ª∞ C·∫¨P NH·∫¨T NGAY ƒê·ªÇ M∆Ø·ª¢T
      if (!selected.includes(idx)) {
        selected.push(idx);
      }

      // G·ª≠i l√™n server ƒë·ªÉ t√≠nh join + ƒë·ªìng b·ªô
      socket.emit('admin_manual_join', {index: idx, username: username});
    } else {
      // T·ª∞ C·∫¨P NH·∫¨T NGAY
      selected = selected.filter(x => x !== idx);

      // G·ª≠i l√™n server ƒë·ªÉ gi·∫£m join
      socket.emit('admin_manual_cancel', {index: idx, username: username});
    }

    // B·ªè tick Select All n·∫øu c·∫ßn
    if (document.getElementById('selectAllCheckbox').checked && !cell.classList.contains('selected')) {
      document.getElementById('selectAllCheckbox').checked = false;
    }
  });
}
  return cell;
}

function renderGrid(){
  grid.innerHTML = '';
  let nameIndex = 0;
  for(let row=1; row<=6; row++){
    for(let col=1; col<=8; col++){
      let cell;
      // T·∫°o 2 √¥ tr·ªëng ·ªü v·ªã tr√≠ 1,5 v√† 1,6
     if(row===1 && (col===5 || col===6)){
  // D√πng index s·ªë √¢m ƒë·ªÉ ph√¢n bi·ªát √¥ tr·ªëng, tr√°nh l·ªói querySelector v√† parseInt
  const emptyIndex = col === 5 ? -1 : -2;
  cell = createCell('', emptyIndex, true);
  cell.classList.add('empty'); // Gi·ªØ class empty
}else {
  const name = names[nameIndex] || '';
  cell = createCell(name, nameIndex);
  nameIndex++;
}
      grid.appendChild(cell);
    }
  }
  // Sau khi render, √°p d·ª•ng l·∫°i tr·∫°ng th√°i selected (ch·ªâ cho Admin)
  if (role === 'admin') {
    selected.forEach(idx => {
      const cell = document.querySelector(`[data-index='${idx}']`);
      if(cell) cell.classList.add('selected');
    });
  }
}

// H√ÄM UPDATE DANH S√ÅCH M·ªöI (V·ªã tr√≠ 2)
function updateParticipantList(participants) {
    participantList.innerHTML = ''; // X√≥a danh s√°ch c≈©
   
    if (participants.length === 0) {
        participantList.innerHTML = '<li>Ch∆∞a c√≥ ai tham gia.</li>';
    } else {
        participants.forEach(p => {
            const listItem = document.createElement('li');
            listItem.innerText = p.username;
            participantList.appendChild(listItem);
        });
    }
    participantCount.innerText = participants.length;
}
// K·∫æT TH√öC H√ÄM UPDATE DANH S√ÅCH M·ªöI


// ----- ADMIN CONTROLS -----
document.getElementById("startBtn")?.addEventListener('click', ()=>{
  if(!selected.length) return alert("Ch·ªçn √≠t nh·∫•t 1 ng∆∞·ªùi!");
 
  // B√°o cho Server/User bi·∫øt Admin b·∫Øt ƒë·∫ßu quay
  socket.emit('admin_start_wheel');

  // Reset h·ªôp k·∫øt qu·∫£
  resultBox.classList.remove("show");

  interval = setInterval(()=>{
    // Lo·∫°i b·ªè l·ªõp 'selected' ·ªü √¥ tr∆∞·ªõc
    const oldIdx = selected[currentIndex === 0 ? selected.length-1 : currentIndex-1];
    const oldCell = document.querySelector(`[data-index='${oldIdx}']`);
    if(oldCell) oldCell.classList.remove("selected");

    // Th√™m l·ªõp 'selected' ·ªü √¥ hi·ªán t·∫°i
    const idx = selected[currentIndex];
    const cell = document.querySelector(`[data-index='${idx}']`);
    if(cell) cell.classList.add("selected");

    tick.currentTime=0;
    tick.play();

    currentIndex=(currentIndex+1)%selected.length;
  },50);
});

document.getElementById("stopBtn")?.addEventListener('click', ()=>{
  if(!selected.length) return alert("Ch·ªçn √≠t nh·∫•t 1 ng∆∞·ªùi!");
 
  clearInterval(interval);
  const winnerIndex = selected[currentIndex===0?selected.length-1:currentIndex-1];
  const winnerName = names[winnerIndex];
 
  // G·ª≠i k·∫øt qu·∫£ chi·∫øn th·∫Øng ƒë·∫øn Server
  socket.emit('admin_stop_wheel', winnerName);

  // X·ª≠ l√Ω hi·ªÉn th·ªã k·∫øt qu·∫£ c·ª•c b·ªô tr√™n m√°y Admin
  resultBox.innerText = "üéâ "+winnerName+" üéâ";
  resultBox.classList.add("show");
  startFireworks();

  // >>> B·ªî SUNG: LO·∫†I B·ªé HI·ªÜU ·ª®NG SELECTED TR√äN C√ÅC √î TR√äN M√ÅY ADMIN
  document.querySelectorAll('.cell').forEach(cell => {
    cell.classList.remove('selected');
  });
 
  // Reset tr·∫°ng th√°i Admin
  selected=[];
  currentIndex=0;
  document.getElementById('selectAllCheckbox').checked = false;
});

const selectAllCheckbox = document.getElementById('selectAllCheckbox');
selectAllCheckbox.addEventListener('change', () => {
  if(!names.length || role !== 'admin') return;

  selected = []; // Reset m·∫£ng selected

  document.querySelectorAll('.cell').forEach((cell, idx) => {
    const index = parseInt(cell.dataset.index);

    // Ch·ªâ x·ª≠ l√Ω √¥ c√≥ t√™n th·∫≠t (index l√† s·ªë >= 0 v√† c√≥ n·ªôi dung)
    if (!isNaN(index) && index >= 0 && cell.innerText.trim() && !cell.classList.contains('empty')) {
      if (selectAllCheckbox.checked) {
        cell.classList.add('selected');
        selected.push(index);

        // G·ª≠i l√™n server ƒë·ªÉ t√≠nh join +1 (m·ªõi th√™m)
        const username = names[index];
        socket.emit('admin_manual_join', {index: index, username: username});
      } else {
        cell.classList.remove('selected');

        // G·ª≠i l√™n server ƒë·ªÉ gi·∫£m join -1 (n·∫øu tr∆∞·ªõc ƒë√≥ ƒë√£ join)
        const username = names[index];
        socket.emit('admin_manual_cancel', {index: index, username: username});
      }
    }
  });
});

// ----- ADMIN LIST CONTROLS M·ªöI (V·ªã tr√≠ 3) -----
// N√∫t Copy Danh s√°ch
copyListBtn.addEventListener('click', async () => {
    // L·∫•y t·∫•t c·∫£ t√™n trong danh s√°ch v√† t·∫°o th√†nh chu·ªói, m·ªói t√™n 1 d√≤ng
    const namesArray = Array.from(participantList.children)
                             .map(li => li.innerText)
                             .filter(name => name !== 'Ch∆∞a c√≥ ai tham gia.');
   
    if (namesArray.length === 0) {
        alert("Danh s√°ch tr·ªëng!");
        return;
    }
   
    const listText = namesArray.join('\n');
   
    try {
        await navigator.clipboard.writeText(listText);
        copyListBtn.innerText = "ƒê√£ Copy! ‚úÖ";
        setTimeout(() => { copyListBtn.innerText = "üìã Copy Danh s√°ch"; }, 1500);
    } catch (err) {
        alert('Kh√¥ng th·ªÉ Copy: ' + err);
    }
});

// N√∫t Reset Danh s√°ch Th·ªß c√¥ng
resetListBtn.addEventListener('click', () => {
    if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô danh s√°ch ng∆∞·ªùi tham gia kh√¥ng?")) {
        return;
    }
   
    // G·ª≠i y√™u c·∫ßu x√≥a danh s√°ch l√™n Server
    socket.emit('admin_reset_participants');
});
// K·∫æT TH√öC ADMIN LIST CONTROLS M·ªöI


// ----- USER CONTROLS -----
confirmBtn?.addEventListener('click', ()=>{
  if(!username) return;
  const userIndex = names.indexOf(username);
  if(userIndex===-1) return;
  
  // G·ª≠i th√¥ng tin tham gia l√™n Server
  socket.emit('user_join', {index:userIndex, username: username});
 
  
  hasJoined = true;
  confirmBtn.style.display = 'none';
  cancelBtn.style.display = 'block';
});

cancelBtn?.addEventListener('click', ()=>{
  if(!hasJoined) return;
  const userIndex = names.indexOf(username);
  if(userIndex===-1) return;

  // G·ª≠i th√¥ng tin h·ªßy tham gia l√™n Server
  socket.emit('user_cancel', {index:userIndex, username: username});
 
  
  hasJoined = false;
  confirmBtn.style.display = 'block';
  cancelBtn.style.display = 'none';
});


// ----- SOCKET.IO LISTENERS (ƒê·ªíNG B·ªò H√ìA) -----

// 1. Nh·∫≠n tr·∫°ng th√°i ban ƒë·∫ßu khi k·∫øt n·ªëi
socket.on('initial_state', (data) => {
    const allCells = document.querySelectorAll(".cell");
    allCells.forEach(c=>c.classList.remove("selected"));

    if (role === 'admin') {
        selected = [];
        // Hi·ªÉn th·ªã c√°c √¥ ƒë√£ ƒë∆∞·ª£c ch·ªçn tr√™n giao di·ªán Admin
        data.participants.forEach(p => {
            selected.push(p.index);
            const cell = document.querySelector(`[data-index='${p.index}']`);
            if(cell) cell.classList.add('selected');
        });
        participantListContainer.style.display = 'block'; // Hi·ªÉn th·ªã khung danh s√°ch
        updateParticipantList(data.participants);
    }
    // User: C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t Tham gia/H·ªßy
    if (role === 'user') {
        hasJoined = data.participants.some(p => p.username === username);
        confirmBtn.style.display = hasJoined ? 'none' : 'block';
        cancelBtn.style.display = hasJoined ? 'block' : 'none';
        participantListContainer.style.display = 'none'; // ·∫®n v·ªõi User
    }
    // N·∫øu l√† Admin, ph·∫£i render grid sau khi ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫°o cell v√† event listener
    if (role === 'admin' && grid.innerHTML === '') renderGrid();
});


// 2. ADMIN: Nh·∫≠n th√¥ng b√°o user tham gia t·ª´ server
socket.on('client_update_join', (data) => {
    if (role === 'admin') {
        const idx = data.index;
        if (!selected.includes(idx)) selected.push(idx);
        const cell = document.querySelector(`[data-index='${idx}']`);
        if(cell) cell.classList.add('selected');
    }
});

// 3. ADMIN: Nh·∫≠n th√¥ng b√°o user h·ªßy t·ª´ server
socket.on('client_update_cancel', (data) => {
    if (role === 'admin') {
        const idx = data.index;
        selected = selected.filter(i => i !== idx);
        const cell = document.querySelector(`[data-index='${idx}']`);
        if(cell) cell.classList.remove('selected');
    }
});

// 4. USER/ADMIN: Nh·∫≠n k·∫øt qu·∫£ v√† ƒë·ªìng b·ªô h√≥a hi·ªÉn th·ªã
socket.on('client_stop_wheel', (winnerName) => {
    // D·ª´ng quay n·∫øu ƒëang quay
    clearInterval(interval); 
   
    resultBox.innerText = "üéâ " + winnerName + " üéâ";
    resultBox.classList.add("show");
    startFireworks();

    // Reset tr·∫°ng th√°i tham gia cho User
    if (role === 'user') {
        hasJoined = false;
        confirmBtn.style.display = 'block';
        cancelBtn.style.display = 'none';
    }
});

// 5. ADMIN: Nh·∫≠n danh s√°ch c·∫≠p nh·∫≠t t·ª´ Server (sau Join/Cancel/Reset/StopWheel) (V·ªã tr√≠ 4)
socket.on('participant_update', (participants) => {
    if (role === 'admin') {
        updateParticipantList(participants);
    }
});


// ----- FIREWORK -----
function startFireworks(){
  const canvas = document.getElementById("fireworks");
  const ctx = canvas.getContext("2d");
  canvas.width = innerWidth;
  canvas.height = innerHeight;
  const particles = [];
  // (Gi·ªØ nguy√™n h√†m createParticle v√† animate)
  function createParticle(){
    const p = {
      x: canvas.width/2,
      y: canvas.height/2,
      radius: Math.random()*3+2,
      color: `hsl(${Math.random()*360},100%,50%)`,
      dx:(Math.random()-0.5)*8,
      dy:(Math.random()-0.5)*8,
      life:100
    };
    particles.push(p);
  }
  for(let i=0;i<120;i++) createParticle();
  function animate(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    particles.forEach((p,i)=>{
      p.x+=p.dx; p.y+=p.dy; p.life--;
      ctx.fillStyle=p.color;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.radius,0,Math.PI*2);
      ctx.fill();
      if(p.life<=0) particles.splice(i,1);
    });
    if(particles.length>0) requestAnimationFrame(animate);
  }
  animate();
}
// ----- CLICK NGO√ÄI ƒê√ìNG RESULT -----
document.addEventListener('click',(e)=>{
  if(resultBox.classList.contains('show') && !resultBox.contains(e.target) && e.target.id!=='stopBtn'){
    resultBox.classList.remove('show');
  }
});
// ====== ADMIN STATS FIX ======

    const loadStatsBtn = document.getElementById('loadStatsBtn');
const statsBody = document.getElementById('statsTableBody');

console.log("BTN =", loadStatsBtn);
console.log("TBODY =", statsBody);

if (loadStatsBtn) {
  loadStatsBtn.addEventListener('click', () => {
    console.log("üì§ CLICK ‚Üí emit admin_request_stats");
    socket.emit('admin_request_stats');
  });
}

socket.on('stats_data', (stats) => {
  console.log("üì• STATS RECEIVED:", stats);

  statsBody.innerHTML = '';

  const arr = Object.entries(stats).map(([name, d]) => ({
    name,
    join: d.join,
    win: d.win,
    rate: d.join ? ((d.win / d.join) * 100).toFixed(1) : '0.0'
  }));

  if (arr.length === 0) {
    statsBody.innerHTML =
      `<tr><td colspan="4">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>`;
    return;
  }

  arr.forEach(r => {
    statsBody.innerHTML += `
      <tr>
        <td>${r.name}</td>
        <td>${r.join}</td>
        <td>${r.win}</td>
        <td>${r.rate}%</td>
      </tr>
    `;
  });
});
</script>


</script>
</body>
</html>
